# Отчёт — подготовка сервера (Vast.ai) и очистка ноутбука (v2)

Дата: 2025‑09‑17

## 1) Работы по серверу (Vast.ai)

- Подбор и развёртывание GPU‑инстанса в бюджете < $10/сутки.
  - Поиск A100‑80/L40S — на момент запуска `rentable=false`.
  - Альтернативы: H200/H100/RTX 5090/4090. Промежуточные офферы с нестабильным SSH‑прокси были удалены.
  - Финальный инстанс: RTX 4090 (Nevada), контракт `25994163`, SSH‑прокси `ssh5.vast.ai:34162`.

- Bootstrap окружения и доступов.
  - Jupyter Lab на `127.0.0.1:8888` в `tmux` (сначала с паролем, затем запущен без токена/пароля, только localhost; включён `allow_origin='*'` для совместимости с Dev Tunnels).
  - Установка Python‑стека: Torch/cu121, Jupyter, OpenAI SDK, CV‑библиотеки, GroundingDINO, SAM‑2.
  - Доустановка зависимостей SAM‑2: `hydra-core`, `omegaconf`, `yacs`, `shapely`, `addict`, `einops`, `opencv-python-headless`, `matplotlib`, `transformers`, `timm`.
  - Скачаны веса моделей в `/root/models`:
    - GroundingDINO: `groundingdino_swint_ogc.pth` (~662 MB)
    - SAM v1 ViT‑H: `sam_vit_h_4b8939.pth` (~2.4 GB)
    - SAM‑2 Large: `sam2_hiera_large.pt` (~857 MB)

- Секреты и данные.
  - Загружен сервис‑аккаунт GCS → `/root/gcs_sa.json`.
  - Проверена аутентификация `google-cloud-storage`.
  - Скачаны артефакты:
    - PDF: `gs://pik_source_bucket/playbooks/...v11.pdf` → `/root/data/playbook.pdf`
    - JSON: `gs://pik_result_bucket/Qdrant_Destination/playbooks/...v11.pdf.json` → `/root/data/playbook.json`

- Базовый прогон пайплайна.
  - Рендер страниц 42/45 → `out/page_images/.../page-42.png`, `page-45.png`.
  - Быстрый детект (CV) → `out/visual/cv_regions/42|45/regions/region-*.json` (7 и 11 регионов соответственно).
  - Анализ регионов (GPT‑4o) → caption/struct/facts.
  - Инжест визуальных фактов → `out/openai_embeddings.ndjson` (+42 записей на шаге CV; ранее +12 в placeholder‑прогоне).
  - Визуальный обзор → `eval/visual_review.html`.
  - Метрики (до CV‑догрузки): recall@1=0.115, @3=0.282, @5=0.359; MRR=0.216 (78 запросов).

- Jupyter/VSCode интеграция.
  - Рекомендовано подключение через Remote‑SSH (без Dev Tunnels) и порт‑форвардинг 8888.
  - Варианты: либо работа в браузере Jupyter через `localhost:8888`, либо ноутбуки прямо в VSCode.

## 2) Изменения в ноутбуке

- Добавлен новый ноутбук: `notebooks/Grounded_DINO_SAM2_Detection_v2.ipynb`.
  - Структура: Проверка окружения → (опционально) GCS → Рендер → Детект (CV | GroundedDINO+SAM2) → Анализ → Инжест → Обзор → Метрики.
  - Конфиг в одной ячейке (страницы, пути, переключение `USE_CV`, модели, индексы).
  - Идемпотентные ячейки, вызовы через готовые CLI из `scripts/` — минимизация дублирования логики.
  - Доп. ячейка регистрации ipykernel для выбора ядра по имени.

- Старый ноутбук сохранён без правок; v2 предназначен для чистого и воспроизводимого запуска локально/удалённо.

## 3) Рекомендации и следующие шаги

- Переключить детект на GroundedDINO+SAM2 в v2 (`USE_CV=False`) и прогнать те же страницы 42/45.
- Переиндексация текста (при необходимости) через `scripts/rebuild_index.py` для балансировки влияния нового пула визуальных фактов.
- Закрепить версии SAM‑2 под используемую версию Torch (при переходе на Torch 2.5.x обновить колёсики `torchvision>=0.20.1`).
- Добавить задачи VSCode (tasks) для запуска основных шагов с одного клика.

## 4) Как связана «удалёнка» с нашим Git

- На сервере в `/root/AiPIK` — самостоятельный клон того же репозитория GitHub.
- Синхронизация по стандартной схеме:
  1) Локально (Mac): `git add/commit/push` → изменения попадают в `origin/main`.
  2) На сервере: `git fetch && git pull --ff-only` — подтягиваем последние изменения.
- Альтернатива: копирование единичных файлов `scp` (быстро, но лучше держать всё через Git для истории и воспроизводимости).

