# Методика интеллектуального визуального парсинга

Цель: извлекать из визуальных артефактов (диаграмм, канвасов, таблиц) структурированные факты и описания, пригодные для индексации и ответов (RAG).

## Шаги методики

1) Подготовка изображений
- Рендер PDF → PNG (150–300 DPI), нормализация размера и контраста при необходимости.
- Разбиение на кандидаты‑регионы:
  - Базово: CV (морфология + контуры) для быстрого охвата.
  - Полный режим: GroundedDINO (open‑vocab detection по списку prompts) → SAM/SAM‑2 для уточнения границ.

2) Детектирование сущностей (GroundedDINO)
- Промпты по типам артефактов: `diagram, canvas, table, legend, node, arrow, textbox`.
- Пороги: `box_threshold≈0.3`, `text_threshold≈0.25` (подбирать на материале).
- Выход: bounding boxes + фразы‑ярлыки (phrases) на региональном уровне.

3) Сегментация (SAM‑2)
- По каждому bbox уточнить маску; для целей RAG достаточно bbox+crop, маску можно хранить отдельно.
- Сохранять crops в PNG и базовые метаданные: `{bbox, score, label}`.

4) OCR/текстовые подсказки (опционально)
- Для регионов с текстом — OCR (DocAI/Azure FR/Tesseract) → подсказка для LLM‑анализа.

5) LLM‑анализ региона
- Модель: gpt‑4o (vision), режим детерминированный.
- Шаблон: 1) краткий caption (1–2 предложения), 2) строгий JSON‑объект по типам артефактов:
  - Canvas: `{layers[], components[], personas[], journey[], relations[]}`
  - Assessment: `{pillars{}, criteria[], questions[], scoring_fields[]}`
  - Diagram: `{entities[], edges[], legend[], groups[]}`

6) Нормализация и факты
- Канонизация: переименование столпов/слоёв (Pillars/Layers) к фиксированным именам.
- Выдача фактографики в JSONL‑виде: triples `{subject, predicate, object, tags}`.

7) Индексация
- Тексты: OpenAI `text-embedding-3-large` (caption + facts + текстовые чанки).
- Изображения (опционально): OpenCLIP (ImageVec) для мультимодального поиска.
- Метаданные: `{type, filename, page, region_id, bbox, tags, preview}`.

8) Валидация
- Визуальный обзор (`eval/visual_review.html`): изображение региона + caption + тип + ссылка на facts.
- Метрики поиска: Recall@k, nDCG, MRR; аудит флагов (miss@1, low_sim, image_top1).

## Практические замечания
- Для диалоговых/сложных канвасов полезно подмешивать OCR‑фразы в подсказку к LLM, но избегать прямого копирования длинного текста.
- Для больших схем оптимальна итеративная детекция: сначала крупные блоки (diagram/canvas/table), затем узлы/стрелки.
- Параметры порогов GroundedDINO подбираются под конкретный корпус.
- Маски SAM‑2 повышают качество нарезки, но для RAG‑фактов достаточно bbox+crop.

## Публикация артефактов
- `gs://pik-artifacts-dev/grounded_regions/<unit>/regions/region-*.{json,png,caption.txt,struct.json,facts.jsonl}`
- Keep‑политика: `models/` — не удалять при общем клине результатов.

