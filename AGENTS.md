Agent Guide — AiPIK (Main Machine)

Scope
- This file applies to the whole repository. It documents how the main machine is set up and how to run notebooks and scripts consistently.

Host Summary
- Hostname: af4e8805195b
- OS: Ubuntu 22.04 (jammy)
- CPU/RAM: 12 vCPU, ~62GiB RAM
- GPU: NVIDIA GeForce RTX 4090 (driver 575.64.03), CUDA toolchain available (nvcc present)
- Python: 3.11.9 (Conda base at /opt/conda)
- Repo root: /root/AiPIK

Directories and Artifacts
- Working directory: /root/AiPIK
- Outputs: out/
  - out/page_images/PIK - Expert Guide - Platform IT Architecture - Playbook - v11 (page-42.png, page-45.png)
  - out/visual/cv_regions
  - out/visual/grounded_regions

Environment Variables
- Required for LLM features: OPENAI_API_KEY
- Common variables used by notebooks/scripts (see .env.example):
  - MODEL_DIR, DATA_DIR, PDF_PATH, JSON_PATH
  - OUT_PAGES, OUT_DET, INDEX_PATH
  - CHAT_MODEL, EMB_MODEL, USE_CV

Network
- This section is auto-populated from the latest snapshot (docs/infra/machine-<hostname>.json).
- To refresh, run: `python3 scripts/system_probe.py` then `python3 scripts/generate_machine_docs.py`.

<!-- BEGIN:AUTOGEN NETWORK -->
Network Summary (autogenerated)
- FQDN: 
- Default: via  dev 
<!-- END:AUTOGEN NETWORK -->

How to Run
- Activate Python if using Conda (optional if base is default):
  - source /opt/conda/etc/profile.d/conda.sh && conda activate base
- Load variables from .env when needed:
  - bash: set -a; [ -f .env ] && source .env; set +a
- Execute notebooks headless:
  - jupyter nbconvert --to notebook --execute --inplace notebooks/Grounded_DINO_SAM2_Detection_v2.ipynb
- Or run scripts directly (examples):
  - python scripts/render_pages.py --pdf "$PDF_PATH" --pages 42 45 --outdir "$OUT_PAGES" --dpi 150
  - python scripts/cv_segment.py --images-dir "$OUT_PAGES" --pages 42 45 --outdir out/visual/cv_regions
  - python scripts/grounded_sam_detect.py --images "$OUT_PAGES/page-42.png" "$OUT_PAGES/page-45.png" --outdir "$OUT_DET" --prompts diagram canvas table legend node arrow
  - python scripts/analyze_detected_regions.py --detected-dir "$OUT_DET" --all --outdir "$OUT_DET" --chat-model "$CHAT_MODEL" --skip-existing
  - python scripts/ingest_visual_artifacts.py --source-json "$JSON_PATH" --regions-dir "$OUT_DET" --out "$INDEX_PATH" --model "$EMB_MODEL"
  - python scripts/generate_visual_review.py --inline
  - python scripts/eval_metrics.py --index "$INDEX_PATH" --eval eval/queries.jsonl --prefer-visual

Notes
- Ensure out/ is writable. If you run in a new environment, create missing subfolders.
- Keep secrets out of git. Put real values in .env (excluded by .gitignore) and commit only .env.example.
- To refresh this machine profile, run: python3 scripts/system_probe.py (writes docs/infra/machine-<hostname>.json)
 - To regenerate docs with network summary, run: python3 scripts/generate_machine_docs.py

Remote Targets
- Codex читает этот файл (AGENTS.md) автоматически, поэтому опишите ниже подключение к удалёнке.
- Рекомендуется завести структурный файл: `docs/infra/remotes.yaml` (локально; не коммитить), пример — `docs/infra/remotes.example.yaml`.
- Минимум нужных полей на целевой хост:
  - alias (ssh), host, port, user, identity_file, workdir (путь к репо), python/conda_prefix, env_file.
- Как использовать на основной машине:
  - Настройте SSH алиас в `~/.ssh/config` (см. пример ниже).
  - Создайте `docs/infra/remotes.yaml` из шаблона и заполните поля (без секретов).
  - Дальше, когда потребуется запуск на удалёнке, мы используем эти параметры (ssh alias, путь, окружение).

SSH config (пример)
- В файл `~/.ssh/config` добавьте:
  - Host mainbox
  -     HostName <IP_или_DNS>
  -     User <user>
  -     Port 22
  -     IdentityFile ~/.ssh/<key>
  -     IdentitiesOnly yes
